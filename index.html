<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Q&A with Supabase</title>
    <!-- Use Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-2xl flex flex-col h-[80vh]">

        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 text-center">
            <h1 class="text-2xl font-bold">Ask Gemini & Save</h1>
            <p class="text-sm">Your questions and answers are stored in Supabase.</p>
        </header>

        <!-- Conversation History Display Area -->
        <div id="history-container" class="flex-grow p-6 overflow-y-auto space-y-4">
            <!-- Messages will be dynamically injected here -->
            <div class="text-center text-gray-400 italic mt-4">Conversation history will appear here.</div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="p-4 text-center text-indigo-500 hidden">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Generating response...
        </div>

        <!-- Input and Button Area -->
        <div class="p-4 bg-gray-50 border-t flex items-center gap-2">
            <textarea id="question-input"
                      class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none text-gray-800"
                      placeholder="Ask a question..."
                      rows="1"></textarea>
            <button id="send-button"
                    class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-300 ease-in-out font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                Send
            </button>
        </div>

    </div>

    <!-- Custom Modal for Alerts -->
    <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-lg font-bold text-red-600 mb-2">Error</h3>
            <p id="alert-message" class="text-sm text-gray-700 mb-4"></p>
            <button id="alert-close" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">OK</button>
        </div>
    </div>

    <!-- The main application script -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Custom alert function to replace window.alert()
        const showAlert = (message) => {
            const modal = document.getElementById('alert-modal');
            const msgEl = document.getElementById('alert-message');
            msgEl.textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeAlert = () => {
            const modal = document.getElementById('alert-modal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        };

        document.getElementById('alert-close').addEventListener('click', closeAlert);

        // Supabase and Gemini API configurations from user input
        const SUPABASE_URL = 'https://heeivzfbsxdxyaxezqdo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlZWl2emZic3hkeHlheGV6cWRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NDYzNDksImV4cCI6MjA3MTUyMjM0OX0.b2DWoCMEJCsjXh0o2PCtoGtEYNbteHbr4FqFJ5isO5U';
        const GEMINI_API_KEY = 'AIzaSyBBMgqdOJjRZ5zBGbS2kxQe9J6MX4mswyw';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        const TABLE_NAME = 'qna_history';

        // Initialize Supabase Client
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Get DOM elements
        const historyContainer = document.getElementById('history-container');
        const questionInput = document.getElementById('question-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Function to create the table if it doesn't exist
        const createTableIfNotExists = async () => {
            try {
                // Attempt to insert a dummy record to see if the table exists
                await supabase.from(TABLE_NAME).insert({ question: 'initial check', answer: 'initial check' });
                // If the insert is successful, we know the table exists. Now delete the dummy record.
                const { data } = await supabase.from(TABLE_NAME).select('id').eq('question', 'initial check').single();
                if (data) {
                    await supabase.from(TABLE_NAME).delete().eq('id', data.id);
                }
                console.log('Table exists.');
            } catch (error) {
                // Supabase throws an error if the table does not exist
                console.warn('Table not found, attempting to create it...');
                try {
                    const { data, error: tableError } = await supabase.rpc('create_qna_history_table');
                    if (tableError) throw tableError;
                    console.log('Table created successfully.');
                } catch (createError) {
                    console.error('Failed to create table:', createError.message);
                    showAlert('Error: Failed to create the database table. Check your Supabase project permissions.');
                }
            }
        };

        // Create a function in Supabase to create the table
        // This is a workaround as Supabase JS client doesn't have a direct `CREATE TABLE` command
        // You would need to add this SQL function manually in your Supabase SQL Editor:
        // CREATE OR REPLACE FUNCTION create_qna_history_table()
        // RETURNS void AS $$
        // BEGIN
        //     CREATE TABLE qna_history (
        //         id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        //         question TEXT,
        //         answer TEXT,
        //         created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        //     );
        // EXCEPTION
        //     WHEN duplicate_table THEN
        //         -- Do nothing if table already exists
        // END;
        // $$ LANGUAGE plpgsql;

        // Function to render a single message
        const renderMessage = (text, type) => {
            const messageEl = document.createElement('div');
            messageEl.className = `p-4 rounded-lg shadow-sm max-w-[85%] ${
                type === 'user' ? 'bg-indigo-100 self-end ml-auto' : 'bg-gray-200 self-start mr-auto'
            }`;
            messageEl.innerText = text;
            historyContainer.appendChild(messageEl);
            historyContainer.scrollTop = historyContainer.scrollHeight;
        };

        // Function to fetch conversation history from Supabase and render it
        const fetchHistory = async () => {
            try {
                const { data, error } = await supabase.from(TABLE_NAME).select('*').order('created_at', { ascending: true });
                if (error) throw error;

                historyContainer.innerHTML = ''; // Clear existing history
                if (data.length === 0) {
                    const noHistoryMessage = document.createElement('div');
                    noHistoryMessage.className = "text-center text-gray-400 italic mt-4";
                    noHistoryMessage.textContent = "Conversation history will appear here.";
                    historyContainer.appendChild(noHistoryMessage);
                } else {
                    data.forEach(entry => {
                        renderMessage(entry.question, 'user');
                        renderMessage(entry.answer, 'bot');
                    });
                }
            } catch (error) {
                console.error('Error fetching history:', error.message);
                showAlert('Failed to load conversation history: ' + error.message);
            }
        };

        // Function to handle sending a message
        const sendMessage = async () => {
            const question = questionInput.value.trim();
            if (!question) {
                showAlert('Please enter a question.');
                return;
            }

            // Display user message immediately
            renderMessage(question, 'user');
            questionInput.value = ''; // Clear input

            sendButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            try {
                // Call the Gemini API
                const payload = {
                    contents: [{ parts: [{ text: question }] }],
                    tools: [{ "google_search": {} }],
                };

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API error: ${response.statusText}`);
                }

                const result = await response.json();
                const answer = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!answer) {
                    throw new Error('No answer received from Gemini.');
                }

                // Store the Q&A in Supabase
                const { error } = await supabase.from(TABLE_NAME).insert([
                    { question: question, answer: answer }
                ]);

                if (error) {
                    throw error;
                }

                // Display the bot's response
                renderMessage(answer, 'bot');

            } catch (error) {
                console.error('Error in sendMessage:', error.message);
                showAlert('An error occurred: ' + error.message);
                renderMessage('Sorry, I couldn\'t get a response. Please try again.', 'bot');
            } finally {
                sendButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        };

        // Event listener for the send button
        sendButton.addEventListener('click', sendMessage);

        // Event listener for the enter key in the textarea
        questionInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevents a new line
                sendMessage();
            }
        });

        // Initial setup on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await createTableIfNotExists();
            await fetchHistory();
        });

    </script>
</body>
</html
